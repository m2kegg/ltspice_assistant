import os
import re
import json
import pandas as pd
import numpy as np
from langchain_community.document_loaders import PyPDFLoader, TextLoader, CSVLoader
from langchain_community.embeddings import HuggingFaceEmbeddings
from langchain_community.vectorstores import FAISS
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain.schema.document import Document

def build_knowledge_base(dir_path, output_path="circuit_knowledge_base"):
    """
    –°–æ–∑–¥–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º —Å—Ö–µ–º–∞–º.
    
    Args:
        dir_path: –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
        output_path: –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã
    
    Returns:
        –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    """
    documents = []
    stats = {"pdf": 0, "txt": 0, "csv": 0, "skipped": 0}
    if not os.path.exists(dir_path):
        return {"status": "error", "message": f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è {dir_path} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"}
    for root, _, files in os.walk(dir_path):
        for file in files:
            file_path = os.path.join(root, file)
            try:
                if file.lower().endswith(".pdf"):
                    loader = PyPDFLoader(file_path)
                    documents.extend(loader.load())
                    stats["pdf"] += 1
                elif file.lower().endswith(".txt"):
                    loader = TextLoader(file_path)
                    documents.extend(loader.load())
                    stats["txt"] += 1
                elif file.lower().endswith(".csv"):
                    loader = CSVLoader(file_path)
                    documents.extend(loader.load())
                    stats["csv"] += 1
            except Exception as e:
                stats["skipped"] += 1
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ {file_path}: {str(e)}")
    
    if not documents:
        return {"status": "error", "message": "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"}
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=1000,
        chunk_overlap=200,
        length_function=len,
    )
    chunks = text_splitter.split_documents(documents)
    try:
        embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2")
        db = FAISS.from_documents(chunks, embeddings)
        db.save_local(output_path)
        return {
            "status": "success", 
            "message": f"–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {output_path}", 
            "stats": {
                "processed_files": stats,
                "total_chunks": len(chunks),
                "total_documents": len(documents)
            }
        }
    except Exception as e:
        return {"status": "error", "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: {str(e)}"}

def search_knowledge_base(query, kb_path="circuit_knowledge_base", top_k=5):
    """
    –ò—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.
    
    Args:
        query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        kb_path: –ü—É—Ç—å –∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        top_k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    
    Returns:
        –°–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    """
    try:
        if not os.path.exists(kb_path):
            return {"status": "error", "message": f"–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –≤ {kb_path} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"}
        
        embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2")
        db = FAISS.load_local(kb_path, embeddings)
        docs = db.similarity_search(query, k=top_k)
        results = []
        for i, doc in enumerate(docs):
            result = {
                "content": doc.page_content,
                "source": doc.metadata.get("source", "Unknown"),
                "page": doc.metadata.get("page", None)
            }
            results.append(result)
        
        return {
            "status": "success",
            "results": results
        }
    except Exception as e:
        return {"status": "error", "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: {str(e)}"}

def add_document_to_kb(document_path, kb_path="circuit_knowledge_base"):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.
    
    Args:
        document_path: –ü—É—Ç—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        kb_path: –ü—É—Ç—å –∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
    
    Returns:
        –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏
    """
    try:
        if not os.path.exists(kb_path):
            return {"status": "error", "message": f"–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –≤ {kb_path} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"}
        documents = []
        if document_path.lower().endswith(".pdf"):
            loader = PyPDFLoader(document_path)
            documents = loader.load()
        elif document_path.lower().endswith(".txt"):
            loader = TextLoader(document_path)
            documents = loader.load()
        elif document_path.lower().endswith(".csv"):
            loader = CSVLoader(document_path)
            documents = loader.load()
        else:
            return {"status": "error", "message": "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞"}
        
        if not documents:
            return {"status": "error", "message": "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç"}
        text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=1000,
            chunk_overlap=200,
            length_function=len,
        )
        chunks = text_splitter.split_documents(documents)
        embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2")
        db = FAISS.load_local(kb_path, embeddings)
        db.add_documents(chunks)
        db.save_local(kb_path)
        
        return {
            "status": "success", 
            "message": f"–î–æ–∫—É–º–µ–Ω—Ç {document_path} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π",
            "chunks_added": len(chunks)
        }
    except Exception as e:
        return {"status": "error", "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {str(e)}"}

def create_sample_circuit_knowledge():
    """
    –°–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–º–µ—Ä –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö —Å—Ö–µ–º–∞—Ö.
    
    Returns:
        –°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏
    """
    try:
        os.makedirs("temp_docs", exist_ok=True)
        stability_info = """
        # –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö —Å—Ö–µ–º
        
        –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π —Å—Ö–µ–º—ã - –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
        
        ## –û—Å–Ω–æ–≤–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        
        1. **–ó–∞–ø–∞—Å –ø–æ —Ñ–∞–∑–µ** - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 45¬∞ –¥–ª—è —Ö–æ—Ä–æ—à–µ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏, –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ 60¬∞ –∏ –≤—ã—à–µ.
           - –ú–µ–Ω–µ–µ 45¬∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
           - 45¬∞-60¬∞: –ø—Ä–∏–µ–º–ª–µ–º–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
           - –ë–æ–ª–µ–µ 60¬∞: —Ö–æ—Ä–æ—à–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
        
        2. **–ó–∞–ø–∞—Å –ø–æ —É—Å–∏–ª–µ–Ω–∏—é** - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–µ –º–µ–Ω–µ–µ 10 –¥–ë.
           - –ú–µ–Ω–µ–µ 6 –¥–ë: –Ω–∏–∑–∫–∏–π –∑–∞–ø–∞—Å
           - 6-10 –¥–ë: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –∑–∞–ø–∞—Å
           - –ë–æ–ª–µ–µ 10 –¥–ë: —Ö–æ—Ä–æ—à–∏–π –∑–∞–ø–∞—Å
        
        ## –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é
        
        1. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –¥–µ–º–ø—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ LC-–∫–æ–Ω—Ç—É—Ä–∞—Ö
        2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –≤ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —É—Å–∏–ª–∏—Ç–µ–ª—è—Ö
        3. –ü–∞—Ä–∞–∑–∏—Ç–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–≤—è–∑–∏
        4. –†–µ–∑–æ–Ω–∞–Ω—Å–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è
        
        ## –ú–µ—Ç–æ–¥—ã –ø–æ–≤—ã—à–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        
        1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤ –≤ —Ü–µ–ø–∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏—Ö –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–æ–≤
        3. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–µ–º–ª—è–Ω—ã—Ö —Ü–µ–ø–µ–π –∞–Ω–∞–ª–æ–≥–æ–≤–æ–π –∏ —Ü–∏—Ñ—Ä–æ–≤–æ–π —á–∞—Å—Ç–∏
        4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ –ø–æ–ª—é—Å–∞
        """
        
        with open("temp_docs/stability_guide.txt", "w", encoding="utf-8") as f:
            f.write(stability_info)
        noise_info = """
        # –®—É–º–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö —Å—Ö–µ–º
        
        –®—É–º–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å—Ö–µ–º–æ–π.
        
        ## –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã —à—É–º–æ–≤
        
        1. **–¢–µ–ø–ª–æ–≤–æ–π —à—É–º** - –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ —Ö–∞–æ—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤ –ø—Ä–∏ –Ω–µ–Ω—É–ª–µ–≤–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ.
           - –§–æ—Ä–º—É–ª–∞: Vn = sqrt(4kTRB), –≥–¥–µ:
             - k - –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ë–æ–ª—å—Ü–º–∞–Ω–∞
             - T - –∞–±—Å–æ–ª—é—Ç–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
             - R - —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
             - B - –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è
        
        2. **–î—Ä–æ–±–æ–≤–æ–π —à—É–º** - –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ –¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–∏—Ä–æ–¥—ã —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ç–æ–∫–∞.
           - –§–æ—Ä–º—É–ª–∞: In = sqrt(2qIB), –≥–¥–µ:
             - q - –∑–∞—Ä—è–¥ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞
             - I - —Ç–æ–∫
             - B - –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è
        
        3. **1/f —à—É–º (—Ñ–ª–∏–∫–∫–µ—Ä-—à—É–º)** - —à—É–º, —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ —á–∞—Å—Ç–æ—Ç–µ.
        
        ## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à—É–º–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        
        1. **–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —à—É–º–∞ (NF)** - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ SNR –Ω–∞ –≤—Ö–æ–¥–µ –∫ SNR –Ω–∞ –≤—ã—Ö–æ–¥–µ.
           - NF = 1 (0 –¥–ë): –∏–¥–µ–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à—É–º–∞
           - NF = 2 (3 –¥–ë): —Å—Ö–µ–º–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–æ–ª—å–∫–æ –∂–µ —à—É–º–∞, —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –Ω–∞ –≤—Ö–æ–¥–µ
        
        2. **–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–∞—è —à—É–º–æ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞** - —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç —à—É–º–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö.
        
        3. **–°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å —à—É–º–∞** - —à—É–º –≤ –µ–¥–∏–Ω–∏—á–Ω–æ–π –ø–æ–ª–æ—Å–µ —á–∞—Å—Ç–æ—Ç.
        
        ## –¢–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —à—É–º–∞
        
        1. –ü–∞—Å—Å–∏–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (—Ä–µ–∑–∏—Å—Ç–æ—Ä—ã, –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä—ã): –±–ª–∏–∑–∫–æ –∫ 0 –¥–ë
        2. –ú–∞–ª–æ—à—É–º—è—â–∏–µ –ø—Ä–µ–¥—É—Å–∏–ª–∏—Ç–µ–ª–∏: 0.5-2 –¥–ë
        3. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–∏–ª–∏—Ç–µ–ª–∏: 3-10 –¥–ë
        4. –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ—Å–∏—Ç–µ–ª–∏: 7-15 –¥–ë
        
        ## –ú–µ—Ç–æ–¥—ã —Å–Ω–∏–∂–µ–Ω–∏—è —à—É–º–∞
        
        1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞–ª–æ—à—É–º—è—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–º–ø–µ–¥–∞–Ω—Å–æ–≤
        3. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        4. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–∏—Ç–∞–Ω–∏—é
        5. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–æ–ª–æ—Å—ã –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è –¥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞
        """
        
        with open("temp_docs/noise_analysis.txt", "w", encoding="utf-8") as f:
            f.write(noise_info)
        
        transient_info = """
        # –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        
        –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.
        
        ## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        
        1. **–í—Ä–µ–º—è –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è (Rise Time)** - –≤—Ä–µ–º—è, –∑–∞ –∫–æ—Ç–æ—Ä–æ–µ —Å–∏–≥–Ω–∞–ª –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç —Å 10% –¥–æ 90% –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏–≤—à–µ–≥–æ—Å—è –∑–Ω–∞—á–µ–Ω–∏—è.
           - –¢–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
             - –í—ã—Å–æ–∫–æ—Å–∫–æ—Ä–æ—Å—Ç–Ω—ã–µ —Å—Ö–µ–º—ã: <1 –Ω—Å
             - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å—Ö–µ–º—ã: 1-10 –Ω—Å
             - –ê–Ω–∞–ª–æ–≥–æ–≤—ã–µ —Å—Ö–µ–º—ã: 0.1-100 –º–∫—Å
        
        2. **–í—Ä–µ–º—è —Å–ø–∞–¥–∞ (Fall Time)** - –≤—Ä–µ–º—è, –∑–∞ –∫–æ—Ç–æ—Ä–æ–µ —Å–∏–≥–Ω–∞–ª —Å–ø–∞–¥–∞–µ—Ç —Å 90% –¥–æ 10% –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏–≤—à–µ–≥–æ—Å—è –∑–Ω–∞—á–µ–Ω–∏—è.
        
        3. **–ü–µ—Ä–µ—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (Overshoot)** - –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–º —É—Å—Ç–∞–Ω–æ–≤–∏–≤—à–µ–≥–æ—Å—è –∑–Ω–∞—á–µ–Ω–∏—è, –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö.
           - –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
             - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Å—Ö–µ–º—ã: <5%
             - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ö–µ–º—ã: 5-15%
             - –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å—Ö–µ–º—ã: –¥–æ 30%
        
        4. **–í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (Settling Time)** - –≤—Ä–µ–º—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å–∏–≥–Ω–∞–ª –≤–æ—à–µ–ª –∏ –æ—Å—Ç–∞–ª—Å—è –≤ –∑–∞–¥–∞–Ω–Ω–æ–π –ø–æ–ª–æ—Å–µ –æ–∫–æ–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∏–≤—à–µ–≥–æ—Å—è –∑–Ω–∞—á–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ ¬±5% –∏–ª–∏ ¬±1%).
        
        5. **–ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è (Propagation Delay)** - –≤—Ä–µ–º—è –º–µ–∂–¥—É –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞.
        
        ## –§–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
        
        1. **–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏ —Ü–µ–ø–µ–π** - RC, RL –∏–ª–∏ LC –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ —Ü–µ–ø–∏.
        
        2. **–ü–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è —É—Å–∏–ª–∏—Ç–µ–ª—è** - —Å–≤—è–∑–∞–Ω–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º Tr ‚âà 0.35/BW.
        
        3. **–°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è (Slew Rate)** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è —É—Å–∏–ª–∏—Ç–µ–ª—è.
        
        4. **–í—Ö–æ–¥–Ω–∞—è –∏ –≤—ã—Ö–æ–¥–Ω–∞—è –µ–º–∫–æ—Å—Ç—å** - –ø–∞—Ä–∞–∑–∏—Ç–Ω—ã–µ –µ–º–∫–æ—Å—Ç–∏ –∑–∞–º–µ–¥–ª—è—é—Ç –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.
        
        ## –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
        
        1. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –¥–µ–º–ø—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–∏–≤–æ–¥—è—â–µ–µ –∫ –∫–æ–ª–µ–±–∞–Ω–∏—è–º
        2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è –≤ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —É—Å–∏–ª–∏—Ç–µ–ª—è—Ö
        3. –ò—Å–∫–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–∏–≥–Ω–∞–ª–∞ –∏–∑-–∑–∞ –Ω–µ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç–µ–π
        4. –ó–≤–æ–Ω (ringing) –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞—Ö –∏–º–ø—É–ª—å—Å–æ–≤
        
        ## –°–ø–æ—Å–æ–±—ã —É–ª—É—á—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        
        1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–µ–º–ø—Ñ–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–±—ã—á–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ–º–ø—Ñ–∏—Ä–æ–≤–∞–Ω–∏—è 0.7 –¥–∞—ë—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫)
        2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        3. –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–∑–∏—Ç–Ω—ã—Ö —ë–º–∫–æ—Å—Ç–µ–π –∏ –∏–Ω–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        4. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏–º–ø–µ–¥–∞–Ω—Å–æ–≤ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏–π
        """
        
        with open("temp_docs/transient_analysis.txt", "w", encoding="utf-8") as f:
            f.write(transient_info)
        frequency_info = """
        # –ß–∞—Å—Ç–æ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (AC-–∞–Ω–∞–ª–∏–∑)
        
        –ß–∞—Å—Ç–æ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Ö–µ–º—ã –≤ —á–∞—Å—Ç–æ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏.
        
        ## –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        
        1. **–ê–º–ø–ª–∏—Ç—É–¥–Ω–æ-—á–∞—Å—Ç–æ—Ç–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ (–ê–ß–•)** - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∞–º–ø–ª–∏—Ç—É–¥—ã –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã –≤—Ö–æ–¥–Ω–æ–≥–æ.
        
        2. **–§–∞–∑–æ-—á–∞—Å—Ç–æ—Ç–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ (–§–ß–•)** - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ñ–∞–∑–æ–≤–æ–≥–æ —Å–¥–≤–∏–≥–∞ –º–µ–∂–¥—É –≤—ã—Ö–æ–¥–Ω—ã–º –∏ –≤—Ö–æ–¥–Ω—ã–º —Å–∏–≥–Ω–∞–ª–∞–º–∏ –æ—Ç —á–∞—Å—Ç–æ—Ç—ã.
        
        3. **–ü–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è** - –¥–∏–∞–ø–∞–∑–æ–Ω —á–∞—Å—Ç–æ—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º –ê–ß–• –Ω–µ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∏–∂–µ —É—Ä–æ–≤–Ω—è -3 –¥–ë –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ.
           - –ê—É–¥–∏–æ—Å—Ö–µ–º—ã: 20 –ì—Ü - 20 –∫–ì—Ü
           - –í–ß-—Å—Ö–µ–º—ã: –¥–æ —Å–æ—Ç–µ–Ω –ú–ì—Ü –∏–ª–∏ –ì–ì—Ü
           - –®–∏—Ä–æ–∫–æ–ø–æ–ª–æ—Å–Ω—ã–µ —É—Å–∏–ª–∏—Ç–µ–ª–∏: –æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ç–æ–∫–∞ –¥–æ –¥–µ—Å—è—Ç–∫–æ–≤ –ú–ì—Ü
        
        4. **–ß–∞—Å—Ç–æ—Ç–∞ –µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è** - —á–∞—Å—Ç–æ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è —Ä–∞–≤–µ–Ω 1 (0 –¥–ë).
        
        5. **–ß–∞—Å—Ç–æ—Ç–∞ —Å—Ä–µ–∑–∞** - —á–∞—Å—Ç–æ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —É—Å–∏–ª–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç –Ω–∞ 3 –¥–ë –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ.
        
        ## –¢–∏–ø—ã —á–∞—Å—Ç–æ—Ç–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        
        1. **–§–∏–ª—å—Ç—Ä –Ω–∏–∂–Ω–∏—Ö —á–∞—Å—Ç–æ—Ç (–§–ù–ß)** - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—ã –Ω–∏–∂–µ —á–∞—Å—Ç–æ—Ç—ã —Å—Ä–µ–∑–∞.
           - –°–∫–æ—Ä–æ—Å—Ç—å —Å–ø–∞–¥–∞: 6 –¥–ë/–æ–∫—Ç–∞–≤—É –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ 1-–≥–æ –ø–æ—Ä—è–¥–∫–∞, 12 –¥–ë/–æ–∫—Ç–∞–≤—É –¥–ª—è 2-–≥–æ –ø–æ—Ä—è–¥–∫–∞ –∏ —Ç.–¥.
        
        2. **–§–∏–ª—å—Ç—Ä –≤–µ—Ä—Ö–Ω–∏—Ö —á–∞—Å—Ç–æ—Ç (–§–í–ß)** - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—ã –≤—ã—à–µ —á–∞—Å—Ç–æ—Ç—ã —Å—Ä–µ–∑–∞.
        
        3. **–ü–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä** - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—ã –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–æ–ª–æ—Å–µ.
           - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π –∏ –¥–æ–±—Ä–æ—Ç–Ω–æ—Å—Ç—å—é (Q)
           - Q = f0 / (f2 - f1), –≥–¥–µ f0 - —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞, f1 –∏ f2 - –Ω–∏–∂–Ω—è—è –∏ –≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç–æ—Ç—ã —Å—Ä–µ–∑–∞
        
        4. **–†–µ–∂–µ–∫—Ç–æ—Ä–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä** - –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—ã –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–æ–ª–æ—Å–µ.
        
        ## –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        
        1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —É—Å–∏–ª–∏—Ç–µ–ª–µ–π
        2. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        3. –ê–Ω–∞–ª–∏–∑ —Ü–µ–ø–µ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        4. –û—Ü–µ–Ω–∫–∞ –ø–æ–º–µ—Ö–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
        
        ## –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        
        1. –í—Ä–µ–º—è –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è ‚âà 0.35 / –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è (–¥–ª—è –§–ù–ß)
        2. –ó–∞–¥–µ—Ä–∂–∫–∞ –≥—Ä—É–ø–ø—ã = -dœÜ/dœâ, –≥–¥–µ œÜ - —Ñ–∞–∑–∞, œâ - —É–≥–ª–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞
        3. –ß–∞—Å—Ç–æ—Ç–∞ —Å—Ä–µ–∑–∞ RC-—Ü–µ–ø–∏ = 1/(2œÄRC)
        """
        
        with open("temp_docs/frequency_analysis.txt", "w", encoding="utf-8") as f:
            f.write(frequency_info)
        monte_carlo_info = """
        # –ê–Ω–∞–ª–∏–∑ –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ
        
        –ê–Ω–∞–ª–∏–∑ –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ —Ä–∞–∑–±—Ä–æ—Å–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ —Ä–∞–±–æ—Ç—É —Å—Ö–µ–º—ã.
        
        ## –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
        
        1. **–°—É—Ç—å –º–µ—Ç–æ–¥–∞** - –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º —Ä–∞–∑–±—Ä–æ—Å–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –∏—Ö –¥–æ–ø—É—Å–∫–∞–º.
        
        2. **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**:
           - –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ: –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–æ–ø—É—Å–∫–∞ —Ä–∞–≤–Ω–æ–≤–µ—Ä–æ—è—Ç–Ω—ã
           - –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ (–≥–∞—É—Å—Å–æ–≤–æ): –±√≥–ª—å—à–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π –±–ª–∏–∂–µ –∫ –Ω–æ–º–∏–Ω–∞–ª—É
           - –õ–æ–≥-–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ: –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è –≤ —à–∏—Ä–æ–∫–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        
        3. **–¢–∏–ø–∏—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π**:
           - –ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: 50-100 –ø—Ä–æ–≥–æ–Ω–æ–≤
           - –î–µ—Ç–∞–ª—å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: 500-1000 –ø—Ä–æ–≥–æ–Ω–æ–≤
           - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ö–µ–º—ã: 1000+ –ø—Ä–æ–≥–æ–Ω–æ–≤
        
        ## –¢–∏–ø–∏—á–Ω—ã–µ –¥–æ–ø—É—Å–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        
        1. **–†–µ–∑–∏—Å—Ç–æ—Ä—ã**:
           - –ü—Ä–µ—Ü–∏–∑–∏–æ–Ω–Ω—ã–µ: ¬±0.1%, ¬±0.5%, ¬±1%
           - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ: ¬±5%, ¬±10%
        
        2. **–ö–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä—ã**:
           - –ö–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–µ: ¬±5%, ¬±10%, ¬±20%
           - –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ: -20%/+80% (–∏–ª–∏ —Ö—É–∂–µ)
           - –ü–ª–µ–Ω–æ—á–Ω—ã–µ: ¬±1%, ¬±5%, ¬±10%
        
        3. **–ü–æ–ª—É–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∏**:
           - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä–æ–≤: —á–∞—Å—Ç–æ ¬±50% –∏–ª–∏ –±–æ–ª—å—à–µ
           - –ü–æ—Ä–æ–≥–æ–≤—ã–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è: –æ–±—ã—á–Ω–æ ¬±10-20%
        
        ## –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        
        1. **–ê–Ω–∞–ª–æ–≥–æ–≤—ã–µ —Å—Ö–µ–º—ã**:
           - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è
           - –ß–∞—Å—Ç–æ—Ç–∞ —Å—Ä–µ–∑–∞
           - –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
           - –®—É–º–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
           - –°–º–µ—â–µ–Ω–∏–µ
        
        2. **–¶–∏—Ñ—Ä–æ–≤—ã–µ —Å—Ö–µ–º—ã**:
           - –ó–∞–¥–µ—Ä–∂–∫–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
           - –í—Ä–µ–º–µ–Ω–∞ –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è/—Å–ø–∞–¥–∞
           - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—Ä–æ–Ω—Ç–æ–≤
        
        3. **–°–º–µ—à–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã**:
           - –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ê–¶–ü/–¶–ê–ü
           - –õ–∏–Ω–µ–π–Ω–æ—Å—Ç—å
           - –î–∂–∏—Ç—Ç–µ—Ä
        
        ## –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        
        1. **–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
           - –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
           - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
           - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏—è
           - –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        
        2. **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞**:
           - –í—ã—Ö–æ–¥ –≥–æ–¥–Ω—ã—Ö (Yield): –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ö–µ–º, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
           - –ó–∞–ø–∞—Å –ø–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
        
        3. **–ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –±–æ–ª–µ–µ –∂–µ—Å—Ç–∫–∏—Ö –¥–æ–ø—É—Å–∫–æ–≤
        
        ## –£–ª—É—á—à–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –≥–æ–¥–Ω—ã—Ö
        
        1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ü–∏–∑–∏–æ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É–∑–ª–∞—Ö
        2. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å—Ö–µ–º —Å –ø–æ–Ω–∏–∂–µ–Ω–Ω–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∫ —Ä–∞–∑–±—Ä–æ—Å—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        3. –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∏–ª–∏ –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
        4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏
        """
        
        with open("temp_docs/monte_carlo.txt", "w", encoding="utf-8") as f:
            f.write(monte_carlo_info)
        
        # –§–∞–π–ª —Å —Ç–∏–ø–æ–≤—ã–º–∏ —Å—Ö–µ–º–∞–º–∏ –∏ –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV)
        typical_circuits_data = """Circuit Type,Application,Key Parameters,Typical Issues,Optimization Tips
–ò–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–∏–π –û–£,–£—Å–∏–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤,–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è, –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è,–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è,–í—ã–±–æ—Ä –û–£ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è
–ù–µ–∏–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—â–∏–π –û–£,–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∏ —É—Å–∏–ª–µ–Ω–∏–µ,–í—Ö–æ–¥–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ, —Ç–æ—á–Ω–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∏—è,–°–º–µ—â–µ–Ω–∏–µ –Ω—É–ª—è –ø—Ä–∏ –±–æ–ª—å—à–æ–º Ku,–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ü–∏–∑–∏–æ–Ω–Ω—ã—Ö –û–£ –¥–ª—è –≤—ã—Å–æ–∫–∏—Ö Ku
–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É—Å–∏–ª–∏—Ç–µ–ª—å,–ò–∑–º–µ—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞,–ö–û–°–°, —Ç–æ—á–Ω–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∏—è,–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤,–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ü–∏–∑–∏–æ–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤
–§–∏–ª—å—Ç—Ä –ë–∞—Ç—Ç–µ—Ä–≤–æ—Ä—Ç–∞ 2-–≥–æ –ø–æ—Ä—è–¥–∫–∞,–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤,–ß–∞—Å—Ç–æ—Ç–∞ —Å—Ä–µ–∑–∞, —Å–∫–æ—Ä–æ—Å—Ç—å —Å–ø–∞–¥–∞ –ê–ß–•,–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —Ä–∞–∑–±—Ä–æ—Å—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤,–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å –ø–æ–º–æ—â—å—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤
–ü–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä –ì–∏–°,–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∑–∫–æ–π –ø–æ–ª–æ—Å—ã,–î–æ–±—Ä–æ—Ç–Ω–æ—Å—Ç—å, —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞,–í—ã—Å–æ–∫–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º,–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
LC-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä,–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤,–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —á–∞—Å—Ç–æ—Ç—ã, –∏—Å–∫–∞–∂–µ–Ω–∏—è,–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã,–¢–µ—Ä–º–æ–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∞–º–ø–ª–∏—Ç—É–¥—ã
–ú—É–ª—å—Ç–∏–≤–∏–±—Ä–∞—Ç–æ—Ä –Ω–∞ –û–£,–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤,–ß–∞—Å—Ç–æ—Ç–∞, —Å–∫–≤–∞–∂–Ω–æ—Å—Ç—å,–î–∂–∏—Ç—Ç–µ—Ä –ø—Ä–∏ –Ω–∏–∑–∫–æ–π —á–∞—Å—Ç–æ—Ç–µ,–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ü–∏–∑–∏–æ–Ω–Ω—ã—Ö –∫–æ–º–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤
–ú–∞–ª–æ—à—É–º—è—â–∏–π –ø—Ä–µ–¥—É—Å–∏–ª–∏—Ç–µ–ª—å,–£—Å–∏–ª–µ–Ω–∏–µ —Å–ª–∞–±—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤,–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —à—É–º–∞, —É—Å–∏–ª–µ–Ω–∏–µ,–ù–∞–≤–æ–¥–∫–∏ –∏ —à—É–º—ã –ø–∏—Ç–∞–Ω–∏—è,–¢—â–∞—Ç–µ–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–∏—Ç–∞–Ω–∏—è
–ò—Å—Ç–æ—á–Ω–∏–∫ –æ–ø–æ—Ä–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è,–°–æ–∑–¥–∞–Ω–∏–µ —ç—Ç–∞–ª–æ–Ω–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è,–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å,–î—Ä–µ–π—Ñ —Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π,–í—ã–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–º–∏ –¢–ö–ù
–ò–º–ø—É–ª—å—Å–Ω—ã–π –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å,–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è,–ö–ü–î, –ø—É–ª—å—Å–∞—Ü–∏–∏, –≠–ú–ò,–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–º–µ—Ö–∏,–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
"""
        
        with open("temp_docs/typical_circuits.csv", "w", encoding="utf-8") as f:
            f.write(typical_circuits_data)
        
        # –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        result = build_knowledge_base("temp_docs", "circuit_knowledge_base")
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        for file in os.listdir("temp_docs"):
            os.remove(os.path.join("temp_docs", file))
        os.rmdir("temp_docs")
        
        return result
    except Exception as e:
        return {"status": "error", "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: {str(e)}"}
        
def rag_enhanced_analysis(query, circuit_type=None, kb_path="circuit_knowledge_base"):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –¥–ª—è –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ö–µ–º—ã.
    
    Args:
        query: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞
        circuit_type: –¢–∏–ø —Å—Ö–µ–º—ã (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω)
        kb_path: –ü—É—Ç—å –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
    
    Returns:
        –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    """
    if not os.path.exists(kb_path):
        create_result = create_sample_circuit_knowledge()
        if create_result["status"] != "success":
            return {
                "status": "error",
                "message": "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è –º–æ–¥–µ–ª–∏."
            }
    search_query = query
    if circuit_type:
        search_query = f"{search_query} {circuit_type}"
    analysis_terms = []
    if "—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å" in query.lower() or "—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å" in query.lower():
        analysis_terms.extend(["–∑–∞–ø–∞—Å –ø–æ —Ñ–∞–∑–µ", "–∑–∞–ø–∞—Å –ø–æ —É—Å–∏–ª–µ–Ω–∏—é", "—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —É—Å–∏–ª–∏—Ç–µ–ª—è"])
    if "—à—É–º" in query.lower() or "–ø–æ–º–µ—Ö" in query.lower():
        analysis_terms.extend(["—à—É–º–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑", "–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —à—É–º–∞", "—à—É–º–æ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞"])
    if "–ø–µ—Ä–µ—Ö–æ–¥" in query.lower() or "–ø–µ—Ä–µ—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ" in query.lower():
        analysis_terms.extend(["–ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å", "–≤—Ä–µ–º—è –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è", "–ø–µ—Ä–µ—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"])
    if "—á–∞—Å—Ç–æ—Ç" in query.lower() or "–∞—á—Ö" in query.lower() or "—Ñ—á—Ö" in query.lower():
        analysis_terms.extend(["–ê–ß–•", "–§–ß–•", "–ø–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è", "—á–∞—Å—Ç–æ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑"])
    if "–º–æ–Ω—Ç–µ" in query.lower() or "—Ä–∞–∑–±—Ä–æ—Å" in query.lower() or "–¥–æ–ø—É—Å–∫" in query.lower():
        analysis_terms.extend(["–ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ", "—Ä–∞–∑–±—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤", "—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"])
    all_results = []
    for term in analysis_terms:
        results = search_knowledge_base(term, kb_path, top_k=2)
        if results.get("status") == "success" and results.get("results"):
            all_results.extend(results["results"])
    if not all_results:
        results = search_knowledge_base(search_query, kb_path, top_k=3)
        if results.get("status") == "success" and results.get("results"):
            all_results = results["results"]
            
    unique_contents = set()
    unique_results = []
    for result in all_results:
        if result["content"] not in unique_contents:
            unique_contents.add(result["content"])
            unique_results.append(result)
    additional_info = ""
    if unique_results:
        additional_info = "### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:\n\n"
        for i, result in enumerate(unique_results[:5]): 
            content = result["content"].strip()
            source = result.get("source", "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è")
            page = f", —Å—Ç—Ä. {result['page']}" if result.get("page") else ""
            
            additional_info += f"**{i+1}. {source}{page}:**\n{content}\n\n"
    else:
        additional_info = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É."
    
    return {
        "status": "success",
        "additional_info": additional_info
    }

def combine_analysis_with_rag(analysis_results, query, circuit_name=None):
    """
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Å—Ö–µ–º—ã —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ RAG.
    
    Args:
        analysis_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Å—Ö–µ–º—ã
        query: –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        circuit_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ)
    
    Returns:
        –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç
    """
    circuit_type = None
    if circuit_name:
        if "op_amp" in circuit_name.lower() or "operational" in circuit_name.lower():
            circuit_type = "–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —É—Å–∏–ª–∏—Ç–µ–ª—å"
        elif "filter" in circuit_name.lower() or "—Ñ–∏–ª—å—Ç—Ä" in circuit_name.lower():
            circuit_type = "—Ñ–∏–ª—å—Ç—Ä"
        elif "power" in circuit_name.lower() or "–ø–∏—Ç–∞–Ω–∏–µ" in circuit_name.lower():
            circuit_type = "–∏—Å—Ç–æ—á–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è"
        elif "oscillator" in circuit_name.lower() or "–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä" in circuit_name.lower():
            circuit_type = "–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä"
    
    rag_info = rag_enhanced_analysis(query, circuit_type)
    
    if isinstance(analysis_results, dict) and analysis_results.get("summary_table"):
        combined_report = f"## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Å—Ö–µ–º—ã {circuit_name or ''}\n\n"
        combined_report += analysis_results.get("summary_table", "") + "\n\n"
        combined_report += "## –í—ã–≤–æ–¥—ã\n\n"
        if "stability" in analysis_results.get("summary", {}):
            stability_info = analysis_results["summary"]["stability"]
            stable_percent = stability_info.get("stable_percentage", 0)
            if stable_percent >= 90:
                combined_report += "‚úÖ –°—Ö–µ–º–∞ –∏–º–µ–µ—Ç –æ—Ç–ª–∏—á–Ω—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å.\n"
            elif stable_percent >= 70:
                combined_report += "‚úÖ –°—Ö–µ–º–∞ –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –µ—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.\n"
            else:
                combined_report += "‚ö†Ô∏è –°—Ö–µ–º–∞ –∏–º–µ–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞.\n"
        
        if "frequency" in analysis_results.get("summary", {}):
            freq_info = analysis_results["summary"]["frequency"]
            if freq_info.get("bandwidth"):
                combined_report += f"üìä –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è: {freq_info['bandwidth']:.2f} –ì—Ü.\n"
            if freq_info.get("max_gain"):
                combined_report += f"üìà –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ: {freq_info['max_gain']:.2f} –¥–ë.\n"
        
        if "monte_carlo" in analysis_results.get("summary", {}):
            mc_info = analysis_results["summary"]["monte_carlo"]
            combined_report += "üîÑ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:\n"
            
            if "rise_time" in mc_info:
                rt_info = mc_info["rise_time"]
                combined_report += f"  - –í—Ä–µ–º—è –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è: {rt_info['mean']:.2e} ¬± {rt_info['std']:.2e} —Å\n"
            
            if "max_gain" in mc_info:
                gain_info = mc_info["max_gain"]
                combined_report += f"  - –£—Å–∏–ª–µ–Ω–∏–µ: {gain_info['mean']:.2f} ¬± {gain_info['std']:.2f} –¥–ë\n"
        
        if rag_info.get("status") == "success" and rag_info.get("additional_info"):
            combined_report += "\n" + rag_info["additional_info"]
    else:
        combined_report = f"## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞\n\n"
        
        if isinstance(analysis_results, dict):
            for key, value in analysis_results.items():
                combined_report += f"### {key}\n{value}\n\n"
        else:
            combined_report += str(analysis_results) + "\n\n"
        
        if rag_info.get("status") == "success" and rag_info.get("additional_info"):
            combined_report += "\n" + rag_info["additional_info"]
    
    return combined_report